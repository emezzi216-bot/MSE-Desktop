<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>MSE Bureau</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* --- DESIGN BUREAU --- */
        :root { --gold: #C5A059; --bg-panel: #1a1a1a; --text: #eee; }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #000; color: var(--text); height: 100vh; overflow: hidden; }

        #dashboard { display: flex; height: 100vh; width: 100vw; }
        
        /* SIDEBAR */
        .sidebar { width: 450px; background: var(--bg-panel); border-right: 1px solid #333; display: flex; flex-direction: column; height: 100%; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #333; text-align: center; }
        .sidebar-logo { width: 100px; max-height: 100px; object-fit: contain; mix-blend-mode: screen; display: block; margin: 0 auto; }
        .btn-change-logo { color: #888; font-size: 11px; margin-top: 10px; cursor: pointer; text-decoration: underline; }
        .controls { flex: 1; overflow-y: auto; padding: 20px; }
        
        /* PREVIEW */
        .preview-area { flex: 1; background: #333; display: flex; justify-content: center; align-items: flex-start; overflow-y: auto; padding: 40px; }
        
        /* FORMULAIRE */
        .group { margin-bottom: 15px; }
        label { display: block; font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px; font-size: 14px; }
        
        .type-switcher { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-type { flex: 1; padding: 10px; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; opacity: 0.5; }
        .btn-type.active { opacity: 1; }
        .btn-gold { background: var(--gold); color: black; }
        .btn-red { background: #D32F2F; color: white; }

        .item-row { background: #252525; padding: 10px; border-radius: 4px; margin-bottom: 8px; border: 1px solid #333; display: flex; gap: 5px; align-items: center; }
        .btn-add { width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: white; cursor: pointer; margin-top: 5px; }
        .btn-trash { background: #422; color: #f88; border: none; width: 30px; height: 30px; cursor: pointer; border-radius: 4px; }
        
        .download-zone { padding: 20px; border-top: 1px solid #333; background: #111; }
        .btn-download { width: 100%; padding: 15px; background: #27ae60; color: white; border: none; font-size: 16px; font-weight: bold; text-transform: uppercase; cursor: pointer; border-radius: 5px; }
        .btn-download:hover { background: #2ecc71; }

        /* PAPIER A4 */
        #paper { 
            background: white; width: 794px; height: 1123px; padding: 0; 
            box-shadow: 0 0 30px rgba(0,0,0,0.5); color: black; font-family: Arial, sans-serif;
            transform: scale(0.75); transform-origin: top center; overflow: hidden; 
        }

        /* PDF INTERNE */
        .pdf-page { padding: 40px; height: 100%; box-sizing: border-box; display: flex; flex-direction: column; }
        .pdf-header { display: flex; justify-content: space-between; margin-bottom: 40px; }
        .pdf-logo { width: 200px; display: block; margin-bottom: 15px; }
        .pdf-client { width: 300px; background: #f4f4f4; padding: 20px; border-left: 5px solid #333; font-size: 13px; }
        .pdf-title-box { border-bottom: 3px solid #D32F2F; padding-bottom: 10px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end; }
        .pdf-title { font-size: 28px; font-weight: bold; text-transform: uppercase; margin: 0; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .pdf-table th { background: #000; color: white; padding: 10px; text-align: left; font-size: 12px; }
        .pdf-table td { border-bottom: 1px solid #ddd; padding: 10px; font-size: 13px; }
        .pdf-totals { display: flex; justify-content: flex-end; margin-top: auto; margin-bottom: 20px; }
        .pdf-totals table { width: 250px; }
        .pdf-totals td { text-align: right; padding: 5px; font-size: 13px; }
        .pdf-total-final { font-size: 18px; font-weight: bold; color: #D32F2F; border-top: 2px solid #000; padding-top: 5px; }
        .pdf-footer { font-size: 10px; color: #555; border-top: 1px solid #ccc; padding-top: 10px; margin-top: auto; }
    </style>
</head>
<body>

    <input type="file" id="logo-uploader" accept="image/*" style="display:none" onchange="updateLogo(this)">

    <div id="dashboard">
        
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="logo.png" class="sidebar-logo" id="sidebar-logo-img" alt="LOGO ICI" onerror="this.style.display='none'">
                <div class="btn-change-logo" onclick="document.getElementById('logo-uploader').click()">CLIQUEZ ICI POUR CHANGER LE LOGO</div>
            </div>
            
            <div class="controls">
                <div class="type-switcher">
                    <button id="btn-facture" class="btn-type btn-gold active" onclick="setType('FACTURE')">FACTURE</button>
                    <button id="btn-devis" class="btn-type btn-red" onclick="setType('DEVIS')">DEVIS</button>
                </div>

                <div class="group"><label>Numéro</label><input type="text" id="inp-num" placeholder="2026-001" oninput="render()"></div>
                
                <div class="group" style="display:flex; gap:10px">
                    <div style="flex:1"><label>Date Émission</label><input type="date" id="inp-date" onchange="render()"></div>
                    <div style="flex:1"><label id="lbl-fin">Échéance</label><input type="date" id="inp-date-fin" onchange="render()"></div>
                </div>

                <div class="group"><label>Objet</label><input type="text" id="inp-obj" placeholder="Objet de la prestation" oninput="render()"></div>
                
                <div class="group"><label>Client</label>
                    <input type="text" id="inp-client" placeholder="Nom Client" list="list-clients" oninput="render()">
                    <textarea id="inp-addr" rows="3" placeholder="Adresse" oninput="render()" style="margin-top:5px"></textarea>
                </div>
                
                <div class="group"><label>Prestations</label><div id="items-list"></div><button class="btn-add" onclick="addItem()">+ LIGNE</button></div>
                
                <div class="group"><label>Règlement</label>
                    <select id="inp-payment" onchange="render()">
                        <option value="Paiement à réception">À réception</option>
                        <option value="Paiement à 30 jours (réception)" selected>30 Jours</option>
                        <option value="Paiement immédiat">Immédiat</option>
                    </select>
                    <div style="margin-top:10px; display:flex; align-items:center; justify-content:space-between">
                        <label style="margin:0">Appliquer TVA (20%)</label> 
                        <input type="checkbox" id="inp-tva" checked onchange="render()" style="width:20px">
                    </div>
                </div>
            </div>
            
            <div class="download-zone"><button class="btn-download" onclick="downloadPDF()">TÉLÉCHARGER PDF</button></div>
        </div>

        <div class="preview-area">
            <div id="paper"></div>
        </div>
    </div>

    <datalist id="list-clients"><option value="COMMUNE DE CRETEIL - CCAS"><option value="Particulier"></datalist>

    <script>
        const USER = { name: "Sabri BENNACEUR EI", address: "2 Résidence des Rosiers, 92800 Puteaux, FR", email: "serruremse@gmail.com", siret: "943032755", iban: "FR76 1695 8000 0159 6810 0824 765", rc: "RC décennale TETRIS police n° SV75018041T37384" };
        
        // Initialisation de l'état avec logo par défaut
        let state = { type: 'FACTURE', logo: 'logo.png', items: [{desc: '', qty: 1, price: 0}] };

        // Dates par défaut
        document.getElementById('inp-date').valueAsDate = new Date();
        const d = new Date(); d.setDate(d.getDate()+30); document.getElementById('inp-date-fin').valueAsDate = d;

        // Lancement initial
        renderItems(); render();

        function setType(t) { 
            state.type = t; 
            document.getElementById('btn-facture').className = `btn-type btn-gold ${t==='FACTURE'?'active':''}`;
            document.getElementById('btn-devis').className = `btn-type btn-red ${t==='DEVIS'?'active':''}`;
            document.getElementById('lbl-fin').innerText = t==='FACTURE'?'Échéance':'Validité';
            render(); 
        }
        
        // --- FONCTION DE MISE A JOUR DU LOGO CORRIGÉE ---
        function updateLogo(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // 1. Mise à jour de la variable d'état
                    state.logo = e.target.result;
                    // 2. Mise à jour immédiate du petit logo en haut à gauche
                    const sidebarLogo = document.getElementById('sidebar-logo-img');
                    sidebarLogo.src = state.logo;
                    sidebarLogo.style.display = 'block';
                    // 3. Mise à jour de la feuille A4
                    render();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function addItem() { state.items.push({desc: '', qty: 1, price: 0}); renderItems(); render(); }
        function removeItem(i) { state.items.splice(i, 1); renderItems(); render(); }
        function updateItem(i, f, v) { state.items[i][f] = v; render(); }

        function renderItems() {
            const list = document.getElementById('items-list'); list.innerHTML = '';
            state.items.forEach((item, i) => {
                list.innerHTML += `<div class="item-row"><input style="flex:3" value="${item.desc}" oninput="updateItem(${i},'desc',this.value)"><input style="flex:1" type="number" value="${item.qty}" oninput="updateItem(${i},'qty',this.value)"><input style="flex:1" type="number" value="${item.price}" oninput="updateItem(${i},'price',this.value)"><button class="btn-trash" onclick="removeItem(${i})">X</button></div>`;
            });
        }

        function render() {
            let totalHT = 0;
            const rows = state.items.map(i => {
                const tot = i.qty * i.price; totalHT += tot;
                return `<tr><td>${i.desc}</td><td style="text-align:center">${i.qty}</td><td style="text-align:right">${Number(i.price).toFixed(2)} €</td><td style="text-align:right">${tot.toFixed(2)} €</td></tr>`;
            }).join('');
            
            const tva = document.getElementById('inp-tva').checked ? totalHT * 0.2 : 0;
            const client = document.getElementById('inp-client').value || 'CLIENT';
            const num = document.getElementById('inp-num').value || 'BROUILLON';

            document.getElementById('paper').innerHTML = `
            <div class="pdf-page">
                <div>
                    <div class="pdf-header">
                        <div>
                            <img src="${state.logo}" class="pdf-logo">
                            <div style="font-size:12px"><strong>${USER.name}</strong><br>${USER.address}<br>SIRET: ${USER.siret}</div>
                        </div>
                        <div class="pdf-client"><strong>FACTURER À :</strong><br><strong style="font-size:16px">${client}</strong><br>${document.getElementById('inp-addr').value.replace(/\n/g,'<br>')}</div>
                    </div>
                    <div class="pdf-title-box">
                        <div><div class="pdf-title">${state.type} N° ${num}</div><div style="font-weight:bold; margin-top:5px; color:#D32F2F">Objet: ${document.getElementById('inp-obj').value}</div></div>
                        <div style="text-align:right">Date: ${new Date(document.getElementById('inp-date').value).toLocaleDateString('fr-FR')}<br>${state.type==='FACTURE'?'Échéance':'Validité'}: ${new Date(document.getElementById('inp-date-fin').value).toLocaleDateString('fr-FR')}</div>
                    </div>
                    <table class="pdf-table"><thead><tr><th style="width:50%">Désignation</th><th>Qté</th><th style="text-align:right">PU HT</th><th style="text-align:right">Total HT</th></tr></thead><tbody>${rows}</tbody></table>
                </div>
                
                <div>
                    <div class="pdf-totals">
                        <table><tr><td>Total HT:</td><td>${totalHT.toFixed(2)} €</td></tr>
                        ${tva > 0 ? `<tr><td>TVA (20%):</td><td>${tva.toFixed(2)} €</td></tr>` : ''}
                        <tr><td class="pdf-total-final">NET À PAYER:</td><td class="pdf-total-final">${(totalHT+tva).toFixed(2)} €</td></tr></table>
                    </div>
                    <div class="pdf-footer">Règlement: ${document.getElementById('inp-payment').value}<br>IBAN: ${USER.iban}</div>
                </div>
            </div>`;
        }

        function downloadPDF() {
            const original = document.getElementById('paper');
            const clone = original.cloneNode(true);
            clone.style.transform = 'none';
            clone.style.boxShadow = 'none';
            clone.style.margin = '0';
            clone.style.width = '794px';
            clone.style.height = '1123px';
            clone.style.maxHeight = '1123px';
            clone.style.overflow = 'hidden';
            clone.style.position = 'fixed'; clone.style.left = '-10000px'; clone.style.top = '0';
            document.body.appendChild(clone);

            const opt = {
                margin: 0,
                filename: `${state.type}_${document.getElementById('inp-num').value || 'doc'}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, windowWidth: 794, height: 1123 },
                jsPDF: { unit: 'px', format: [794, 1123], orientation: 'portrait' }
            };

            html2pdf().set(opt).from(clone).save().then(() => {
                document.body.removeChild(clone);
            });
        }
    </script>
</body>
</html>
