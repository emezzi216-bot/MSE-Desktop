<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>MSE Bureau - Édition Fidèle</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* --- INTERFACE DASHBOARD PC --- */
        :root { --gold: #C5A059; --bg-panel: #1a1a1a; --text: #eee; }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #000; color: var(--text); height: 100vh; overflow: hidden; }

        #dashboard { display: flex; height: 100vh; width: 100vw; }
        
        .sidebar { width: 450px; background: var(--bg-panel); border-right: 1px solid #333; display: flex; flex-direction: column; height: 100%; z-index: 10; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #333; text-align: center; }
        .sidebar-logo { width: 100px; max-height: 100px; object-fit: contain; mix-blend-mode: screen; display: block; margin: 0 auto; }
        
        .controls { flex: 1; overflow-y: auto; padding: 20px; }
        .group { margin-bottom: 15px; }
        label { display: block; font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px; font-size: 14px; }
        
        .type-switcher { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-type { flex: 1; padding: 10px; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; opacity: 0.5; }
        .btn-type.active { opacity: 1; }
        .btn-gold { background: var(--gold); color: black; }
        .btn-red { background: #D32F2F; color: white; }

        .item-row { background: #252525; padding: 10px; border-radius: 4px; margin-bottom: 8px; border: 1px solid #333; display: flex; gap: 5px; align-items: center; }
        .btn-trash { background: #422; color: #f88; border: none; width: 30px; height: 30px; cursor: pointer; border-radius: 4px; }
        .btn-add { width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: white; cursor: pointer; margin-top: 5px; }
        
        .download-zone { padding: 20px; border-top: 1px solid #333; background: #111; }
        .btn-download { width: 100%; padding: 15px; background: #27ae60; color: white; border: none; font-size: 16px; font-weight: bold; text-transform: uppercase; cursor: pointer; border-radius: 5px; width: 100%; }

        /* --- ZONE DE PREVISUALISATION --- */
        .preview-area { flex: 1; background: #333; display: flex; justify-content: center; align-items: flex-start; overflow-y: auto; padding: 40px; }

        /* LA FEUILLE (Strictement identique à la structure V15 mobile) */
        #paper-preview { 
            background: white; 
            width: 794px; /* A4 96dpi */
            min-height: 1123px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5); 
            transform: scale(0.8); /* Ajustement pour voir sur PC */
            transform-origin: top center;
            color: black;
        }

        /* --- STYLES INTERNES (COPIE CONFORME V15) --- */
        .pdf-page { width: 100%; padding: 20px; box-sizing: border-box; font-family: Arial, sans-serif; color: #000; font-size: 12px; line-height: 1.4; }
        .pdf-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; gap: 20px; }
        .pdf-sender-col { flex: 1; min-width: 200px; }
        .pdf-logo { width: 180px; display: block; margin-bottom: 10px; } 
        .pdf-sender-txt { font-size: 11px; color: #333; }
        .pdf-client-col { flex: 1; min-width: 200px; background-color: #f0f0f0; padding: 15px; border-left: 5px solid #333; font-size: 13px; }
        .pdf-title-row { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 3px solid #D32F2F; padding-bottom: 10px; margin-bottom: 20px; }
        .pdf-title { font-size: 20px; font-weight: bold; margin: 0; text-transform: uppercase; }
        .pdf-dates { text-align: right; font-size: 11px; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .pdf-table th { background-color: #000; color: #fff; padding: 8px; text-align: left; font-weight: bold; font-size: 11px; text-transform: uppercase; }
        .pdf-table td { border-bottom: 1px solid #ccc; padding: 8px; vertical-align: top; }
        .pdf-totals-section { display: flex; justify-content: flex-end; }
        .pdf-totals-table { width: 250px; border-collapse: collapse; }
        .pdf-totals-table td { text-align: right; padding: 5px; font-size: 13px; }
        .pdf-ttc { font-size: 16px; font-weight: bold; color: #D32F2F; border-top: 2px solid #000; padding-top: 5px; }
        .pdf-footer { margin-top: 40px; font-size: 10px; color: #444; border-top: 1px solid #ddd; padding-top: 10px; }
        .pdf-bank { background: #eee; padding: 8px; margin-top: 5px; font-family: monospace; border-left: 3px solid #D32F2F; }
    </style>
</head>
<body>

    <input type="file" id="logo-uploader" accept="image/*" style="display:none" onchange="updateLogo(this)">

    <div id="dashboard">
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="logo.png.png" class="sidebar-logo" id="sidebar-logo-img" onerror="this.src='logo.png'">
                <div style="font-size:11px; color:#666; margin-top:10px; cursor:pointer" onclick="document.getElementById('logo-uploader').click()">CHANGER LOGO</div>
            </div>
            
            <div class="controls">
                <div class="type-switcher">
                    <button id="btn-facture" class="btn-type btn-gold active" onclick="setType('FACTURE')">FACTURE</button>
                    <button id="btn-devis" class="btn-type btn-red" onclick="setType('DEVIS')">DEVIS</button>
                </div>
                <div class="group"><label>Numéro</label><input type="text" id="inp-num" placeholder="2026-001" oninput="render()"></div>
                <div class="group" style="display:flex; gap:10px">
                    <div style="flex:1"><label>Date Émission</label><input type="date" id="inp-date" onchange="render()"></div>
                    <div style="flex:1"><label id="lbl-fin">Échéance</label><input type="date" id="inp-date-fin" onchange="render()"></div>
                </div>
                <div class="group"><label>Objet</label><input type="text" id="inp-obj" placeholder="Objet..." oninput="render()"></div>
                <div class="group"><label>Client</label>
                    <input type="text" id="inp-client" placeholder="Nom" list="list-clients" oninput="render()">
                    <textarea id="inp-addr" rows="3" placeholder="Adresse" oninput="render()" style="margin-top:5px"></textarea>
                    <input type="text" id="inp-siret" placeholder="SIRET Client" oninput="render()" style="margin-top:5px">
                </div>
                <div class="group"><label>Prestations</label><div id="items-list"></div><button class="btn-add" onclick="addItem()">+ LIGNE</button></div>
                <div class="group"><label>Règlement</label>
                    <select id="inp-payment" onchange="render()">
                        <option value="Paiement à réception">À réception</option>
                        <option value="Paiement à 30 jours (réception)" selected>30 Jours</option>
                        <option value="Paiement immédiat">Immédiat</option>
                    </select>
                    <div style="margin-top:10px; display:flex; align-items:center; justify-content:space-between">
                        <label style="margin:0">TVA (20%)</label><input type="checkbox" id="inp-tva" checked onchange="render()" style="width:20px">
                    </div>
                </div>
            </div>
            <div class="download-zone"><button class="btn-download" onclick="downloadPDF()">TÉLÉCHARGER PDF</button></div>
        </div>

        <div class="preview-area">
            <div id="paper-preview"></div>
        </div>
    </div>

    <datalist id="list-clients"><option value="COMMUNE DE CRETEIL - CCAS"><option value="Particulier"></datalist>

    <script>
        const USER = { name: "Sabri BENNACEUR EI", address: "2 Résidence des Rosiers, 92800 Puteaux, FR", email: "serruremse@gmail.com", siret: "943032755", iban: "FR76 1695 8000 0159 6810 0824 765", rc: "RC décennale TETRIS police n° SV75018041T37384" };
        let state = { type: 'FACTURE', logo: 'logo.png.png', items: [{desc: '', qty: 1, price: 0}] };

        document.getElementById('inp-date').valueAsDate = new Date();
        const d = new Date(); d.setDate(d.getDate()+30); document.getElementById('inp-date-fin').valueAsDate = d;

        renderItems(); render();

        function setType(t) { 
            state.type = t; 
            document.getElementById('btn-facture').className = `btn-type btn-gold ${t==='FACTURE'?'active':''}`;
            document.getElementById('btn-devis').className = `btn-type btn-red ${t==='DEVIS'?'active':''}`;
            document.getElementById('lbl-fin').innerText = t==='FACTURE'?'Échéance':'Validité';
            render(); 
        }
        
        function updateLogo(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    state.logo = e.target.result;
                    document.getElementById('sidebar-logo-img').src = state.logo;
                    render();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function addItem() { state.items.push({desc: '', qty: 1, price: 0}); renderItems(); render(); }
        function removeItem(i) { state.items.splice(i, 1); renderItems(); render(); }
        function updateItem(i, f, v) { state.items[i][f] = v; render(); }

        function renderItems() {
            const list = document.getElementById('items-list'); list.innerHTML = '';
            state.items.forEach((item, i) => {
                list.innerHTML += `<div class="item-row"><input style="flex:3" value="${item.desc}" oninput="updateItem(${i},'desc',this.value)"><input style="flex:1" type="number" value="${item.qty}" oninput="updateItem(${i},'qty',this.value)"><input style="flex:1" type="number" value="${item.price}" oninput="updateItem(${i},'price',this.value)"><button class="btn-trash" onclick="removeItem(${i})">X</button></div>`;
            });
        }

        function render() {
            let totalHT = 0;
            const rows = state.items.map(i => {
                const tot = i.qty * i.price; totalHT += tot;
                return `<tr><td>${i.desc}</td><td style="text-align:center">${i.qty}</td><td style="text-align:right">${Number(i.price).toFixed(2)} €</td><td style="text-align:right">${tot.toFixed(2)} €</td></tr>`;
            }).join('');
            const tva = document.getElementById('inp-tva').checked ? totalHT * 0.2 : 0;
            const ttc = totalHT + tva;
            const client = document.getElementById('inp-client').value || 'CLIENT';
            const num = document.getElementById('inp-num').value || 'BROUILLON';
            const date = new Date(document.getElementById('inp-date').value).toLocaleDateString('fr-FR');
            const dateFin = new Date(document.getElementById('inp-date-fin').value).toLocaleDateString('fr-FR');
            const clientSiret = document.getElementById('inp-siret').value;

            // STRUCTURE HTML IDENTIQUE V15 MOBILE
            document.getElementById('paper-preview').innerHTML = `
            <div class="pdf-page">
                <div class="pdf-header">
                    <div class="pdf-sender-col">
                        <img src="${state.logo}" class="pdf-logo" onerror="this.src='logo.png'">
                        <div class="pdf-sender-txt">
                            <strong>${USER.name}</strong><br>${USER.address}<br>Email : ${USER.email}<br>SIRET : ${USER.siret}<br>${USER.rc}
                        </div>
                    </div>
                    <div class="pdf-client-col">
                        <strong style="color:#D32F2F;">FACTURER À :</strong><br><br>
                        <strong>${client}</strong><br>
                        ${document.getElementById('inp-addr').value.replace(/\n/g,'<br>')}
                        ${clientSiret ? `<br>SIRET : ${clientSiret}` : ''}
                    </div>
                </div>
                <div class="pdf-title-row">
                    <div>
                        <h1 class="pdf-title">${state.type} N° ${num}</h1>
                        <div style="font-size:13px; margin-top:5px; color:#D32F2F; font-weight:bold;">Objet : ${document.getElementById('inp-obj').value}</div>
                    </div>
                    <div class="pdf-dates">Date : ${date}<br>${state.type === 'FACTURE' ? "Échéance" : "Validité"} : ${dateFin}</div>
                </div>
                <table class="pdf-table">
                    <thead><tr><th style="width:50%">DÉSIGNATION</th><th style="text-align:center">QTÉ</th><th style="text-align:right">P.U. HT</th><th style="text-align:right">TOTAL HT</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
                <div class="pdf-totals-section">
                    <table class="pdf-totals-table">
                        <tr><td>Total HT :</td><td>${totalHT.toFixed(2)} €</td></tr>
                        ${tva > 0 ? `<tr><td>TVA (20%) :</td><td>${tva.toFixed(2)} €</td></tr>` : ''}
                        <tr><td class="pdf-ttc">NET À PAYER :</td><td class="pdf-ttc">${ttc.toFixed(2)} €</td></tr>
                    </table>
                </div>
                <div class="pdf-footer">
                    <div style="display:flex; justify-content:space-between;">
                        <div style="width:60%">
                            <strong>Règlement :</strong> ${document.getElementById('inp-payment').value}<br>
                            <span style="font-size:10px">Pas d'escompte pour paiement anticipé. Retard : taux légal en vigueur + 40€ indemnité.</span>
                            <div class="pdf-bank">IBAN : ${USER.iban}</div>
                        </div>
                        <div style="width:30%; text-align:right;">
                            ${state.type === 'DEVIS' ? '<div style="border:1px solid #ccc; height:60px; padding:5px; font-size:10px;">Bon pour accord (Date & Signature)</div>' : ''}
                        </div>
                    </div>
                    <div style="text-align:center; margin-top:20px; color:#999; font-size:10px;">
                        ${USER.name} - ${state.type} ${num} ${!document.getElementById('inp-tva').checked ? '- TVA non applicable, art. 293 B du CGI.' : ''}
                    </div>
                </div>
            </div>`;
        }

        function downloadPDF() {
            const element = document.getElementById('paper-preview');
            const oldTransform = element.style.transform;
            
            // On force le zoom à 1 (taille réelle) avant la capture
            element.style.transform = 'none';
            element.style.boxShadow = 'none';

            const opt = {
                margin: 0,
                filename: `${state.type}_${document.getElementById('inp-num').value || 'doc'}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0, windowWidth: 800 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                // On remet le zoom écran
                element.style.transform = oldTransform;
                element.style.boxShadow = '0 0 30px rgba(0,0,0,0.5)';
            });
        }
    </script>
</body>
</html>
